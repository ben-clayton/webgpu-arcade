<!doctype html>

<html>

<head>
  <meta charset='utf-8'>
  <meta name='viewport' content='width=device-width, initial-scale=1, user-scalable=no'>
  <meta name='mobile-web-app-capable' content='yes'>
  <meta name='apple-mobile-web-app-capable' content='yes'>

  <meta http-equiv="origin-trial" valid-till="Oct 1, 2021"
    content="AmW6YjtkXDuz0jJ1YP7yPdaAIJ0b49+fF93EH3g2MEMyHGTOcPQASBcngvOOJwmtlgYGxwDwYxApPEWcqUlP5gMAAABOeyJvcmlnaW4iOiJodHRwczovL3RvamkuZ2l0aHViLmlvOjQ0MyIsImZlYXR1cmUiOiJXZWJHUFUiLCJleHBpcnkiOjE2NDMxNTUxOTl9">

  <link rel="shortcut icon" href="favicon.ico" type="image/x-icon" />

  <title>Toro</title>

  <style>
    html,
    body {
      height: 100%;
      margin: 0;
      background-color: #000000;
    }

    canvas {
      position: absolute;
      z-index: 0;
      height: 100%;
      width: 100%;
      left: 0;
      top: 0;
      right: 0;
      bottom: 0;
      margin: 0;
      touch-action: none;
    }

    .dg.main {
      position: absolute;
      z-index: 100;
      top: 1em;
      right: 1em;
    }
  </style>
</head>

<body>
  <canvas></canvas>

  <script type="importmap">
    {
        "imports": {
            "gl-matrix": "../node_modules/gl-matrix/esm/index.js",
            "webgpu-texture-loader": "../node_modules/web-texture-tool/build/webgpu-texture-loader.js",
            "dat.gui": "../node_modules/dat.gui/build/dat.gui.module.js",
            "stats.js": "../node_modules/stats.js/src/Stats.js",
            "engine/": "../engine/"
        }
    }
    </script>

  <script type="module">
    import { Transform } from 'engine/core/transform.js';
    import { Camera } from 'engine/core/camera.js';
    import { SpriteParticleEmitter, TrailParticleEmitter } from 'engine/core/particle.js';
    import { Skybox } from 'engine/core/skybox.js';
    import { Mesh, AABB } from 'engine/core/mesh.js';

    import { GltfLoader } from 'engine/loaders/gltf.js';

    import { FlyingControls, FlyingControlsSystem } from 'engine/controls/flying-controls.js';
    import { OrbitControls, OrbitControlsSystem } from 'engine/controls/orbit-controls.js';

    import { BoneVisualizerSystem } from 'engine/debug/bone-visualizer.js';
    import { BoundsVisualizerSystem } from 'engine/debug/bounds-visualizer.js';

    import { WebGPUWorld } from 'engine/webgpu/webgpu-world.js';

    import { BoxGeometry } from 'engine/geometry/box.js';
    import { PBRMaterial, UnlitMaterial } from 'engine/core/materials.js';
    import { WebGPULightSpriteSystem } from 'engine/webgpu/webgpu-light-sprite.js';

    import { vec3, quat } from 'gl-matrix';

    import dat from 'dat.gui';
    import Stats from 'stats.js';

    let gui = new dat.GUI();

    document.body.appendChild(gui.domElement);

    const stats = new Stats();
    document.body.appendChild(stats.dom);

    const canvas = document.querySelector('canvas');

    const world = new WebGPUWorld(canvas);
    world
      .registerSystem(FlyingControlsSystem)
      .registerSystem(OrbitControlsSystem);

    const renderer = await world.renderer();

    const gltfLoader = new GltfLoader(renderer);

    const projection = new Camera();
    projection.zNear = 1;
    projection.zFar = 1024;

    const orbitControls = new OrbitControls();
    orbitControls.distance = 10;
    orbitControls.maxDistance = 50;
    orbitControls.angle = [0.25, 0];

    const camera = world.create(
      new Transform({ position: [0, 0, 10] }),
      orbitControls,
      projection
    );

    // Add a skybox
    world.create(new Skybox(renderer.textureLoader.fromUrl('./media/textures/skybox/cube-basis-mipmap.ktx2')));

    // Add some particles
    const sprite_particles = world.create(
      new Transform({ position: [-10, 5, 0] }),
      new SpriteParticleEmitter({
        attractor: vec3.create(),
        spawn_radius: 0.0,
      })
    );
    const trail_particles = world.create(
      new Transform({ position: [10, 5, 0] }),
      new TrailParticleEmitter({
        attractor: vec3.create(),
        spawn_radius: 0.0,
      })
    );

    const appSettings = {
      controls: 'orbit',
    };

    gui.add(appSettings, 'controls', {
      'Orbit': 'orbit',
      'Flying': 'flying',
    }).onChange(() => {
      switch (appSettings.controls) {
        case 'orbit': {
          camera.remove(FlyingControls);
          camera.add(orbitControls);
          break;
        }
        case 'flying': {
          camera.remove(OrbitControls);
          const flyingControls = new FlyingControls();
          flyingControls.speed = 10;
          camera.add(flyingControls);
          break;
        }
      }
    });

    {
      const emitter = trail_particles.get(TrailParticleEmitter);
      const trail = gui.addFolder('trail');
      trail.add(emitter, 'num_particles').min(0);
      trail.add(emitter, 'spawn_rate').min(0);
      trail.add(emitter, 'spawn_radius').min(0);
      trail.add(emitter, 'particle_size_start').min(0);
      trail.add(emitter, 'particle_size_end').min(0);
      trail.add(emitter, 'particle_alpha_start').min(0);
      trail.add(emitter, 'particle_alpha_end').min(0);
      trail.add(emitter, 'attractor_strength').min(0);
      trail.add(emitter, 'particle_life_from').min(0);
      trail.add(emitter, 'particle_life_to').min(0);
      trail.add(emitter, 'speed_from').min(0);
      trail.add(emitter, 'speed_to').min(0);
      trail.add(emitter, 'spread').min(0);
      trail.add(emitter, 'gravity').min(0);
    }

    {
      const emitter = sprite_particles.get(SpriteParticleEmitter);
      const trail = gui.addFolder('sprite');
      trail.add(emitter, 'num_particles').min(0);
      trail.add(emitter, 'spawn_rate').min(0);
      trail.add(emitter, 'spawn_radius').min(0);
      trail.add(emitter, 'particle_size_start').min(0);
      trail.add(emitter, 'particle_size_end').min(0);
      trail.add(emitter, 'particle_alpha_start').min(0);
      trail.add(emitter, 'particle_alpha_end').min(0);
      trail.add(emitter, 'attractor_strength').min(0);
      trail.add(emitter, 'particle_life_from').min(0);
      trail.add(emitter, 'particle_life_to').min(0);
      trail.add(emitter, 'speed_from').min(0);
      trail.add(emitter, 'speed_to').min(0);
      trail.add(emitter, 'spread').min(0);
      trail.add(emitter, 'gravity').min(0);
    }


    function onFrame() {
      requestAnimationFrame(onFrame);

      stats.begin();
      world.execute();
      stats.end();
    }
    requestAnimationFrame(onFrame);
  </script>
</body>

</html>
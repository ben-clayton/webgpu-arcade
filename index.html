<!doctype html>

<html>
  <head>
    <meta charset='utf-8'>
    <meta name='viewport' content='width=device-width, initial-scale=1, user-scalable=no'>
    <meta name='mobile-web-app-capable' content='yes'>
    <meta name='apple-mobile-web-app-capable' content='yes'>

    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon" />

    <title>Toro</title>

    <style>
      html, body {
        height: 100%;
        margin: 0;
        background-color: #000000;
      }

      canvas {
        position: absolute;
        z-index: 0;
        height: 100%;
        width: 100%;
        left: 0;
        top: 0;
        right: 0;
        bottom: 0;
        margin: 0;
        touch-action: none;
      }

      .dg.main {
        position: absolute;
        z-index: 100;
        top: 1em;
        right: 1em;
      }
    </style>
  </head>
  <body>
    <canvas></canvas>

    <script type="importmap">
    {
        "imports": {
            "gl-matrix": "./node_modules/gl-matrix/dist/esm/index.js",
            "webgl-texture-loader": "./node_modules/web-texture-tool/build/webgl-texture-loader.js",
            "webgpu-texture-loader": "./node_modules/web-texture-tool/build/webgpu-texture-loader.js",
            "dat.gui": "./node_modules/dat.gui/build/dat.gui.module.js",
            "stats.js": "./node_modules/stats.js/src/Stats.js",
            "ecs": "./js/ecs/ecs.js"
        }
    }
    </script>
    <script type="module">
      import { World } from 'ecs';

      import { Transform } from './js/core/transform.js';
      import { Camera } from './js/core/camera.js';
      import { PointLight, AmbientLight } from './js/core/light.js';

      import { InputSystem } from './js/input/input.js';
      import { FlyingControls, FlyingControlsSystem } from './js/input/flying-controls.js';
      import { OrbitControls, OrbitControlsSystem } from './js/input/orbit-controls.js';

      import { WebGPUWorld } from './js/webgpu/webgpu-world.js';
      import { WebGPULightSystem } from './js/webgpu/webgpu-light.js';
      import { WebGPUCameraSystem } from './js/webgpu/webgpu-camera.js';
      import { WebGPUClusteredLights } from './js/webgpu/webgpu-clustered-light.js';
      import { WebGPURenderer } from './js/webgpu/webgpu-renderer.js';
      import { WebGPULightSpriteSystem } from './js/webgpu/webgpu-light-sprite.js';
      import { WebGPUGeometrySystem } from './js/webgpu/webgpu-geometry.js';
      import { WebGPUDefaultPipelineSystem } from './js/webgpu/webgpu-pipeline.js';

      import { createCubeGeometry } from './js/cube-geometry.js';

      import dat from 'dat.gui';
      import Stats from 'stats.js';

      const appSettings = {
        controls: 'orbit',
      };

      let gui = new dat.GUI();

      document.body.appendChild(gui.domElement);

      const stats = new Stats();
      document.body.appendChild(stats.dom);

      const world = new WebGPUWorld(document.querySelector('canvas'));
      world
        .registerSystem(InputSystem)
        .registerSystem(FlyingControlsSystem)
        .registerSystem(OrbitControlsSystem)
        // Unfortunately the order of these systems is kind of delicate.
        .registerGPUSystem(WebGPULightSystem)
        .registerGPUSystem(WebGPUCameraSystem)
        .registerGPUSystem(WebGPUClusteredLights)
        .registerGPUSystem(WebGPULightSpriteSystem)
        .registerGPUSystem(WebGPUGeometrySystem)
        .registerGPUSystem(WebGPUDefaultPipelineSystem)
        .registerGPUSystem(WebGPURenderer);

      const camera = world.create(
        new Transform([0, 0, 3]),
        new OrbitControls(),
        new Camera()
      );

      const cube = world.create(
        new Transform([0, 0, 0]),
        createCubeGeometry(),
      );

      // Add some lights
      world.create(
        new Transform([5, 5, 5]),
        new PointLight(1, 0.3, 0.3)
      );

      world.create(
        new Transform([-5, 5, -5]),
        new PointLight(0.3, 1, 0.3)
      );

      world.create(
        new AmbientLight(0.0, 0.0, 0.1)
      );

      gui.add(appSettings, 'controls', {
        'Orbit': 'orbit',
        'Flying': 'flying',
      }).onChange(() => {
        switch (appSettings.controls) {
          case 'orbit': {
            camera.remove(FlyingControls);
            camera.add(new OrbitControls());
            break;
          }
          case 'flying': {
            camera.remove(OrbitControls);
            camera.add(new FlyingControls());
            break;
          }
        }
      });

      function onFrame() {
        requestAnimationFrame(onFrame);

        stats.begin();
        world.execute();
        stats.end();
      }
      requestAnimationFrame(onFrame);
    </script>
  </body>
</html>